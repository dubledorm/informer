# README

# Инструкция по сборке
* Перейти в директорию проекта
* Запустить команду:
````
docker-compose build weather-informer
````
* Проверить сборку после завершения, запустить команду:
````
docker images | grep weather-informer
````

# Инструкция по развёртыванию
* Создать папку.
* В неё скопировать файл 'docker-compose.yml'
* Создать в той же папке файл '.env', содержащий переменные окружения. Список переменных и пример файла:
````
DATABASE_NAME=informer_production
DATABASE_USERNAME=informer_user
DATABASE_PASSWORD=пароль
SECRET_KEY_BASE=секретный ключ для БД

WEATHER_SERVICE_CITY_URL=http://api.openweathermap.org/geo/1.0/direct
WEATHER_SERVICE_WEATHER_URL=https://api.openweathermap.org/data/2.5/weather
WEATHER_SERVICE_API_KEY=ключ API, полученный от провайдера
````
* Создать в той же папке файл init.sql. Это файл для первонаяальной инициализации БД. Содержимое файла:
````
CREATE USER informer_user WITH PASSWORD 'пароль';
ALTER USER informer_user WITH SUPERUSER;
CREATE DATABASE informer_production;
grant all privileges on database informer_production to informer_user;
````
* Создать в той же папке файл init.sh. Также используется для первоначальной инициализации. Содержимое файла:
````
docker exec -it db psql -U postgres -p 5432 -f /docker-entrypoint-initdb.d/init.sql
docker exec -it weather-informer bundle exec rake db:migrate
docker exec -it weather-informer bundle exec rake db:seed
````
* Запустить контейнеры:
````
docker-compose up
````
* Выполнить скрипт инициализации:
````
sh init.sh
````
* Проверить, что создалась бд и пользователь можно командами
````
docker exec -it db psql -U postgres -p 5432 -c '\l'

        Name         |  Owner   | Encoding |  Collate   |   Ctype    | ICU Locale | Locale Provider |     Access privileges      
---------------------+----------+----------+------------+------------+------------+-----------------+----------------------------
 informer_production | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | =Tc/postgres              +
                     |          |          |            |            |            |                 | postgres=CTc/postgres     +
                     |          |          |            |            |            |                 | informer_user=CTc/postgres
 postgres            | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | 
 template0           | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | =c/postgres               +
                     |          |          |            |            |            |                 | postgres=CTc/postgres
 template1           | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | =c/postgres               +
                     |          |          |            |            |            |                 | postgres=CTc/postgres
(4 rows)


docker exec -it db psql -U postgres -p 5432 -c '\du'

                                    List of roles
   Role name   |                         Attributes                         | Member of 
---------------+------------------------------------------------------------+-----------
 informer_user | Superuser                                                  | {}
 postgres      | Superuser, Create role, Create DB, Replication, Bypass RLS | {}

````
* Далее, можно обращаться на текущий сервер на порт 3000.
По умолчанию заведён пользователь с правами администратора:
````
admin@example.com
password
````

# Инструкция по проверке работоспособности
## Проверка функций администратора
* Зайдите в установленную систему используя аккаунт по умолчанию:
````
  Логин: admin@example.com
  Пароль: password
````
* Убедитесь, что доступны пункты меню Начальная страница, Пользователи, Точки
* Зайдите в пункт меню Точки.
* Убедитесь что доступны действия 'Создать Точка' и  'Добавить город'
* Нажмите 'Создать Точка'. Откроется форма ввода для создания местоположения по географическим координатам, т.е. без привязки к названию города
* Заполните форму и нажмите Create Точка. Должна отобразиться панель, содержащая введённые данные о точке и панель, содержащаая данные о погоде.
* Ошибки - если введены неверные значения широты и долготы, то об этом будет сообщение, если вводимое имя уже существует, то тоже.
* Нажмите кнопку 'Добавить город'
* Откроется форма для ввода названия города. Введите London
* Т.к. городов с таким название несколько, то откроется форма, выводящая список таких городов и предлагающих выбрать нужный.
* Выберите город. Подтвердите решение. Должна отобразиться панель, содержащая введённые данные о точке и панель, содержащаая данные о погоде.
* Ошибки - если город с таким названием уже существует, то откроется дополнительная форма, предлагающая изменить название города.

## Проверка функций пользователя
* Разлогиньтесь
* На форме ввода пароля выберите пункт 'Зарегистрироваться'
* Заполните EMail и два раза пароль. После этого вы попадёте в систему
* Убедитесь, что доступны пункты меню Начальная страница и Точки. А Пользователи - нет
* Зайдите в пункт меню Точки.
* Убедитесь что не доступны действия 'Создать Точка' и  'Добавить город'
* Выберите любой город из представленного списка
* Должна отобразиться панель, содержащая данные о точке и панель, содержащаая данные о погоде.
Если в процессе получения данных о погоде произойдёт ошибка, то вместо данных о погоде будет выведено сообщение об ошибке.

## Проверка функций управления пользователями
* Зайдите под учётной записью администратора
* Зайдите в список пользователей
* Зайдите в запись пользовтеля, созданную на предыдущем шаге, т.е. не администратора
* Убедитесь, что доступна кнопка 'Назначить админом'
* Нажмите
* Убедитесь, что в записи пользователя поле Администратор стало 'Да', а кнопка 'Назначить админом' сменилась на 'Снять админа'
* Нажмите 'Снять админа'
*  Убедитесь, что в записи пользователя поле Администратор стало 'Нет', а кнопка 'Снять админа' сменилась на 'Назначить админом' 

# Структура кода:
* Бизнес логика вынесена в отдельную папку  Operation.
* В ней структура папок совпадает со структурой домена.
* Реализовано решение, когда все бизнес операции возвращают одинаковую структуру ответа и не используют exceptions. Базовый класс для создания структур ответов BaseReaderResponse лежит в корне папки operation.
* Бизнес логика не работает напрямую с провайдером погоды. Для этого используется промежуточный адаптер, который настраивается в блоке config/initialize/operation.rb.
Базовый класс для создания таких адаптеров WeatherReaderBase лежит в корне папки operation.
* Текущая реализация адаптера лежит в папке services
* Реализация всех форм ввода и отображений находится в папке admin. Также в папке views/admin находятся дополнительные партиалы, используемые для отображения.

# ТЗ на доработку
* Добавить отдельный entry_point - HealthCheck
* При старте программы ввести проверку на установленость всех переменных окружения. Если не установлены, то падать с развёрнутым сообщением об ошибке

# Ограничения
* Не настраивал почтовый клиент для отправки письма для сброса пароля. Всё готово для этого, но времени требует на чисто админские операции
